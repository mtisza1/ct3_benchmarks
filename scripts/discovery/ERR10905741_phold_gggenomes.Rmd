---
title: "genome plot of phold annotations ERR10905741"
output: html_notebook
---

especially for unique calls (either genomad or cenote-taker), it will be useful to have info on these genomes.
gggenomes makes nice plots for this and phold is a somewhat orthogonal annotation method.
```{r}
# load libraries
library(data.table)
library(stringr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)
library(rprojroot)
library(gggenomes)
library(wesanderson)

```

```{r}
color_map = c(
  "head and packaging" = "#469BEC",
  "tail" = "#EB8D43",
  "transcription regulation" = "#DBA662",
  "DNA, RNA and nucleotide metabolism" = "#F2D56F",
  "other" = "#DFDED3",
  "moron, auxiliary metabolic gene and host takeover" = "#A89F8E",
  "connector" = "#8CBEB1",
  "lysis" = "#48594E",
  "integration and excision" = "#9B6981"
)
```

## phold ERR10905741 cenote-taker prediction only
load product table and prep for gggenomes
```{r}
ERR10905741_ct_phold_prod_dt <- fread(sprintf(
    "%s/data/discovery/ERR10905741/phold_annotations/phold_ERR10905741_ct3/phold_per_cds_predictions.tsv",
    find_rstudio_root_file()
  ),
  sep = "\t",
  header = T) %>%
  rename(gene_orient = strand,
         evidence_description = product,
         gene_name = cds_id,
         seq_id = contig_id,
         function_cat = `function`) %>%
  select(
    c("seq_id", "gene_name", 
      "start", "end", 
      "gene_orient", "evidence_description", 
      "function_cat"
      )
    ) %>%
  mutate(
    evidence_description = na_if(evidence_description,"hypothetical protein"),
    function_cat  = na_if(function_cat,"unknown function"),
    function_cat  = na_if(function_cat,""),
    important_virion = case_when(
      grepl(
        "major capsid|major head|terminase large|portal", 
        evidence_description, 
        ignore.case = T) ~ 0.5,
      TRUE ~ 0
    ),
    gene_lab_imp = case_when(
      grepl(
        "major capsid|major head", 
        evidence_description, 
        ignore.case = T) ~ "MCP",
      grepl(
        "terminase large", 
        evidence_description, 
        ignore.case = T) ~ "TerL",
      grepl(
        "portal", 
        evidence_description, 
        ignore.case = T) ~ "Portal",
      TRUE ~ ""
    )
  )

```

```{r}
ERR10905741_ct_phold_prod_dt %>%
  group_by(seq_id) %>%
  summarize(n = n())
```


plot gggenomes object
```{r}

ERR10905741_ct_ggg <-  ERR10905741_ct_phold_prod_dt %>%
  group_by(seq_id) %>%
  mutate(n_genes = n()) %>%
  ungroup() %>%
  filter(n_genes <= 200) %>%
  gggenomes() +
  geom_seq() +
  geom_gene(aes(fill=function_cat, stroke=important_virion), size = 3.5, 
            shape = c(4,1)
  ) +
  geom_gene_text(aes(label=gene_lab_imp)) +
  #geom_bin_label() +
  theme(legend.position = "bottom") +
  scale_fill_manual(values=color_map, na.value="cornsilk3")

ERR10905741_ct_ggg

ggsave(
  ERR10905741_ct_ggg,
  file = sprintf(
    "%s/charts/ERR10905741_ct3_only_phold_maps.shorter.pdf",
    find_rstudio_root_file()
  ),
  width = 9,
  height = 7
)

```

longer contigs
```{r}

ERR10905741_ct_l_ggg <-  ERR10905741_ct_phold_prod_dt %>%
  group_by(seq_id) %>%
  mutate(n_genes = n()) %>%
  ungroup() %>%
  filter(n_genes > 200) %>%
  gggenomes() +
  geom_seq() +
  geom_gene(aes(fill=function_cat, stroke=important_virion), size = 3.5, 
            shape = c(4,1)
  ) +
  geom_gene_text(aes(label=gene_lab_imp), nudge_y = 0.21) +
  #geom_bin_label() +
  theme(legend.position = "bottom") +
  scale_fill_manual(values=color_map, na.value="cornsilk3")

ERR10905741_ct_l_ggg

ggsave(
  ERR10905741_ct_l_ggg,
  file = sprintf(
    "%s/charts/ERR10905741_ct3_only_phold_maps.longer.pdf",
    find_rstudio_root_file()
  ),
  width = 9,
  height = 5
)

```

```{r}
ERR10905741_ct_phold_prod_dt %>%
  complete(seq_id, function_cat) %>%
  filter(function_cat %in% c("connector", "head and packaging", "tail")) %>%
  group_by(seq_id, function_cat) %>%
  summarize(func_count = n()) %>%
  ggplot(aes(x = seq_id, y = func_count, fill = function_cat)) +
  geom_col()
  
```


```{r}
ERR10905741_ct_struct_p <- ERR10905741_ct_phold_prod_dt %>%
  group_by(seq_id) %>%
  summarize(MCP = sum(grepl("major head protein", 
                                   evidence_description,
                                   ignore.case = T)),
            TerL = sum(grepl("terminase large subunit", 
                                   evidence_description,
                                   ignore.case = T)),
            Portal = sum(grepl("portal", 
                                   evidence_description,
                                   ignore.case = T))) %>%
  pivot_longer(cols = c("MCP", "TerL", "Portal"),
               names_to = "structure",
               values_to = "number_annotated") %>%
  
  ggplot(aes(x = structure, y = seq_id, fill = number_annotated)) +
  geom_tile() +
  theme_bw() +
  scale_fill_gradientn(colours = c('white', "#91D5DE", "#2E8289"),
                       name = "number\nannotated") +
  labs(x = "",
       y = "Genome Name") +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_blank()
    )

ERR10905741_ct_struct_p

ggsave(
  ERR10905741_ct_struct_p,
  file = sprintf(
    "%s/charts/ERR10905741_ct3_only_struct_tiles.pdf",
    find_rstudio_root_file()
  ),
  width = 4,
  height = 5
)
```


## phold ERR10905741 genomad prediction only
load product table and prep for gggenomes
```{r}
ERR10905741_gnmd_phold_prod_dt <- fread(sprintf(
    "%s/data/discovery/ERR10905741/phold_annotations/phold_ERR10905741_gnmd/phold_per_cds_predictions.tsv",
    find_rstudio_root_file()
  ),
  sep = "\t",
  header = T) %>%
  rename(gene_orient = strand,
         evidence_description = product,
         gene_name = cds_id,
         seq_id = contig_id,
         function_cat = `function`) %>%
  select(
    c("seq_id", "gene_name", 
      "start", "end", 
      "gene_orient", "evidence_description", 
      "function_cat"
      )
    ) %>%
  mutate(
    evidence_description = na_if(evidence_description,"hypothetical protein"),
    function_cat  = na_if(function_cat,"unknown function"),
    function_cat  = na_if(function_cat,""),
    important_virion = case_when(
      grepl(
        "major capsid|major head|terminase large|portal", 
        evidence_description, 
        ignore.case = T) ~ 0.5,
      TRUE ~ 0
    ),
    gene_lab_imp = case_when(
      grepl(
        "major capsid|major head", 
        evidence_description, 
        ignore.case = T) ~ "MCP",
      grepl(
        "terminase large", 
        evidence_description, 
        ignore.case = T) ~ "TerL",
      grepl(
        "portal", 
        evidence_description, 
        ignore.case = T) ~ "Portal",
      TRUE ~ ""
    )
  )

```

```{r}
ERR10905741_gnmd_phold_prod_dt %>%
  group_by(seq_id) %>%
  summarize(n = n())
```


plot gggenomes object
```{r}

ERR10905741_gnmd_ggg <-  ERR10905741_gnmd_phold_prod_dt %>%
  group_by(seq_id) %>%
  mutate(n_genes = n()) %>%
  ungroup() %>%
  filter(n_genes <= 50) %>%
  gggenomes() +
  geom_seq() +
  geom_gene(aes(fill=function_cat, stroke=important_virion), size = 2, 
            shape = c(4,1)
  ) +
  geom_gene_text(aes(label=gene_lab_imp)) +
  #geom_bin_label() +
  theme(legend.position = "bottom") +
  scale_fill_manual(values=color_map, na.value="cornsilk3")

ERR10905741_gnmd_ggg

ggsave(
  ERR10905741_gnmd_ggg,
  file = sprintf(
    "%s/charts/ERR10905741_gnmd_only_phold_maps.shorter.pdf",
    find_rstudio_root_file()
  ),
  width = 9,
  height = 16
)

```

```{r}

ERR10905741_gnmd_l_ggg <-  ERR10905741_gnmd_phold_prod_dt %>%
  group_by(seq_id) %>%
  mutate(n_genes = n()) %>%
  ungroup() %>%
  filter(n_genes > 50) %>%
  gggenomes() +
  geom_seq() +
  geom_gene(aes(fill=function_cat, stroke=important_virion), size = 3.5, 
            shape = c(4,1)
  ) +
  geom_gene_text(aes(label=gene_lab_imp), nudge_y = 0.31) +
  #geom_bin_label() +
  theme(legend.position = "bottom") +
  scale_fill_manual(values=color_map, na.value="cornsilk3")

ERR10905741_gnmd_l_ggg

ggsave(
  ERR10905741_gnmd_l_ggg,
  file = sprintf(
    "%s/charts/ERR10905741_gnmd_only_phold_maps.longer.pdf",
    find_rstudio_root_file()
  ),
  width = 9,
  height = 6
)

```

```{r}
ERR10905741_gnmd_phold_prod_dt %>%
  complete(seq_id, function_cat) %>%
  filter(function_cat %in% c("connector", "head and packaging", "tail")) %>%
  group_by(seq_id, function_cat) %>%
  summarize(func_count = n()) %>%
  ggplot(aes(x = seq_id, y = func_count, fill = function_cat)) +
  geom_col()
  
```


```{r}
ERR10905741_gnmd_struct_p <- ERR10905741_gnmd_phold_prod_dt %>%
  group_by(seq_id) %>%
  summarize(MCP = sum(grepl("major head protein", 
                                   evidence_description,
                                   ignore.case = T)),
            TerL = sum(grepl("terminase large subunit", 
                                   evidence_description,
                                   ignore.case = T)),
            Portal = sum(grepl("portal", 
                                   evidence_description,
                                   ignore.case = T))) %>%
  pivot_longer(cols = c("MCP", "TerL", "Portal"),
               names_to = "structure",
               values_to = "number_annotated") %>%
  
  ggplot(aes(x = structure, y = seq_id, fill = number_annotated)) +
  geom_tile() +
  theme_bw() +
  scale_fill_gradientn(colours = c('white', "#91D5DE", "#2E8289"),
                       name = "number\nannotated") +
  labs(x = "",
       y = "Genome Name") +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_blank()
    )

ERR10905741_gnmd_struct_p

ggsave(
  ERR10905741_gnmd_struct_p,
  file = sprintf(
    "%s/charts/ERR10905741_gnmd_only_struct_tiles.pdf",
    find_rstudio_root_file()
  ),
  width = 4,
  height = 5
)
```

